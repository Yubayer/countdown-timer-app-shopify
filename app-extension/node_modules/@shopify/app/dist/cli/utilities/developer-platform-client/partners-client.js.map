{"version":3,"file":"partners-client.js","sourceRoot":"","sources":["../../../../src/cli/utilities/developer-platform-client/partners-client.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,cAAc,EAAuB,MAAM,iCAAiC,CAAA;AACpF,OAAO,EACL,+BAA+B,GAEhC,MAAM,4CAA4C,CAAA;AAEnD,OAAO,EAAC,oBAAoB,EAAkB,MAAM,uDAAuD,CAAA;AAC3G,OAAO,EACL,yBAAyB,EACzB,kBAAkB,EAClB,eAAe,EACf,cAAc,EACd,mBAAmB,GACpB,MAAM,oCAAoC,CAAA;AAE3C,OAAO,EAAC,wBAAwB,EAAC,MAAM,sBAAsB,CAAA;AAE7D,OAAO,EAAC,mBAAmB,EAAC,MAAM,2DAA2D,CAAA;AAC7F,OAAO,EACL,iCAAiC,GAElC,MAAM,sDAAsD,CAAA;AAC7D,OAAO,EAAC,qBAAqB,EAA8B,MAAM,yCAAyC,CAAA;AAC1G,OAAO,EAEL,4BAA4B,GAE7B,MAAM,mCAAmC,CAAA;AAC1C,OAAO,EAAC,SAAS,EAAsC,MAAM,iCAAiC,CAAA;AAC9F,OAAO,EACL,uBAAuB,GAGxB,MAAM,iDAAiD,CAAA;AACxD,OAAO,EAAC,UAAU,EAAC,MAAM,qCAAqC,CAAA;AAC9D,OAAO,EAAC,UAAU,EAAC,MAAM,6BAA6B,CAAA;AACtD,OAAO,EACL,iCAAiC,EAEjC,eAAe,GAChB,MAAM,oCAAoC,CAAA;AAE3C,OAAO,EAAC,2BAA2B,EAAC,MAAM,+BAA+B,CAAA;AAEzE,mGAAmG;AACnG,8DAA8D;AAC9D,MAAM,SAAS,GAAG,2CAA2C,CAAA;AAC7D,MAAM,kBAAkB,GAAG,oDAAoD,CAAA;AAW/E,SAAS,UAAU,CAAC,GAAiB,EAAE,IAAY,EAAE,YAAY,GAAG,IAAI,EAAE,WAAsB;IAC9F,IAAI,YAAY,EAAE;QAChB,OAAO;YACL,GAAG,EAAE,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,EAAE,CAAC;YACzB,KAAK,EAAE,GAAG,IAAI,EAAE;YAChB,MAAM,EAAE,qBAAqB;YAC7B,KAAK,EAAE,CAAC,8BAA8B,CAAC;YACvC,qBAAqB,EAAE,WAAW,IAAI,EAAE;YACxC,IAAI,EAAE,WAAW;SAClB,CAAA;KACF;SAAM;QACL,OAAO;YACL,GAAG,EAAE,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,EAAE,CAAC;YACzB,KAAK,EAAE,GAAG,IAAI,EAAE;YAChB,MAAM,EAAE,SAAS;YACjB,KAAK,EAAE,CAAC,kBAAkB,CAAC;YAC3B,qBAAqB,EAAE,EAAE;YACzB,IAAI,EAAE,WAAW;SAClB,CAAA;KACF;AACH,CAAC;AAED,MAAM,OAAO,cAAc;IAGzB,YAAY,OAAyB;QACnC,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAA;IACzB,CAAC;IAED,KAAK,CAAC,OAAO;QACX,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;YAClB,IAAI,UAAU,EAAE,EAAE;gBAChB,MAAM,IAAI,KAAK,CAAC,2EAA2E,CAAC,CAAA;aAC7F;YACD,IAAI,CAAC,QAAQ,GAAG,MAAM,oBAAoB,EAAE,CAAA;SAC7C;QACD,OAAO,IAAI,CAAC,QAAQ,CAAA;IACtB,CAAC;IAED,KAAK,CAAC,WAAW,CAAI,KAAa,EAAE,YAA0C,SAAS;QACrF,OAAO,eAAe,CAAC,KAAK,EAAE,MAAM,IAAI,CAAC,KAAK,EAAE,EAAE,SAAS,CAAC,CAAA;IAC9D,CAAC;IAED,KAAK,CAAC,KAAK;QACT,OAAO,CAAC,MAAM,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,KAAK,CAAA;IACrC,CAAC;IAED,KAAK,CAAC,YAAY;QAChB,MAAM,QAAQ,GAAG,MAAM,2BAA2B,CAAC,EAAE,EAAE,OAAO,CAAC,GAAG,EAAE,EAAC,QAAQ,EAAE,IAAI,EAAC,CAAC,CAAA;QACrF,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,OAAO,EAAE,CAAA;QACpC,IAAI,QAAQ,EAAE;YACZ,OAAO,CAAC,KAAK,GAAG,QAAQ,CAAA;SACzB;QACD,OAAO,OAAO,CAAC,KAAK,CAAA;IACtB,CAAC;IAED,KAAK,CAAC,WAAW;QACf,OAAO,CAAC,MAAM,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,WAAW,CAAA;IAC3C,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,KAAa;QAC3B,OAAO,yBAAyB,CAAC,KAAK,EAAE,MAAM,IAAI,CAAC,KAAK,EAAE,CAAC,CAAA;IAC7D,CAAC;IAED,KAAK,CAAC,aAAa;QACjB,OAAO,kBAAkB,CAAC,MAAM,IAAI,CAAC,OAAO,EAAE,CAAC,CAAA;IACjD,CAAC;IAED,KAAK,CAAC,SAAS;QACb,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,aAAa,EAAE,CAAA;QAChD,OAAO,wBAAwB,CAAC,aAAa,CAAC,CAAA;IAChD,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,KAAa;QAC3B,OAAO,cAAc,CAAC,KAAK,EAAE,MAAM,IAAI,CAAC,OAAO,EAAE,CAAC,CAAA;IACpD,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,KAAa;QAC5B,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,KAAK,EAAE,MAAM,IAAI,CAAC,OAAO,EAAE,CAAC,CAAA;QACjE,OAAO;YACL,YAAY,EAAE,MAAM,CAAC,YAAY;YACjC,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,KAAK;YACvB,YAAY,EAAE,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW;SAC/C,CAAA;IACH,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,cAAsB,EAAE,IAAa;QACpD,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,cAAc,EAAE,MAAM,IAAI,CAAC,OAAO,EAAE,EAAE,IAAI,CAAC,CAAA;QAChF,OAAO;YACL,IAAI,EAAE,MAAM,CAAC,IAAI,CAAC,KAAK;YACvB,YAAY,EAAE,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW;SAC/C,CAAA;IACH,CAAC;IAED,KAAK,CAAC,cAAc,CAAC,KAAa;QAChC,OAAO,mBAAmB,CAAC,EAAC,KAAK,EAAE,MAAM,IAAI,CAAC,KAAK,EAAE,EAAE,MAAM,EAAE,KAAK,EAAC,CAAC,CAAA;IACxE,CAAC;IAED,KAAK,CAAC,SAAS,CACb,GAAiB,EACjB,IAAY,EACZ,OAIC;QAED,MAAM,SAAS,GAAG,UAAU,CAAC,GAAG,EAAE,IAAI,EAAE,OAAO,EAAE,YAAY,EAAE,OAAO,EAAE,WAAW,CAAC,CAAA;QACpF,MAAM,MAAM,GAAyB,MAAM,IAAI,CAAC,WAAW,CAAC,cAAc,EAAE,SAAS,CAAC,CAAA;QACtF,IAAI,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE;YAC1C,MAAM,MAAM,GAAG,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;YACnF,MAAM,IAAI,UAAU,CAAC,MAAM,CAAC,CAAA;SAC7B;QAED,MAAM,KAAK,GAAG,mBAAmB,CAAC,MAAM,CAAC,SAAS,CAAC,GAAG,CAAC,aAAa,CAAC,CAAA;QACrE,OAAO,EAAC,GAAG,MAAM,CAAC,SAAS,CAAC,GAAG,EAAE,cAAc,EAAE,GAAG,CAAC,EAAE,EAAE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAC,CAAA;IAC/E,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,KAAa;QACjC,MAAM,MAAM,GAAqC,MAAM,IAAI,CAAC,WAAW,CAAC,+BAA+B,EAAE;YACvG,EAAE,EAAE,KAAK;SACV,CAAC,CAAA;QACF,OAAO,MAAM,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC,CAAE,CAAC,MAAM,CAAC,KAAK,CAAA;IACpD,CAAC;IAED,KAAK,CAAC,yBAAyB,CAAC,KAAa;QAC3C,OAAO,IAAI,CAAC,WAAW,CAAC,iCAAiC,EAAE,EAAC,MAAM,EAAE,KAAK,EAAC,CAAC,CAAA;IAC7E,CAAC;IAED,KAAK,CAAC,gBAAgB,CAAC,KAAa;QAClC,OAAO,IAAI,CAAC,WAAW,CAAC,qBAAqB,EAAE,EAAC,MAAM,EAAE,KAAK,EAAC,CAAC,CAAA;IACjE,CAAC;IAED,KAAK,CAAC,iBAAiB;QACrB,OAAO,IAAI,CAAC,WAAW,CAAC,iCAAiC,CAAC,CAAA;IAC5D,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,cAAyC;QAC7D,OAAO,IAAI,CAAC,WAAW,CAAC,4BAA4B,EAAE,cAAc,CAAC,CAAA;IACvE,CAAC;IAED,KAAK,CAAC,MAAM,CAAC,WAA+B;QAC1C,OAAO,IAAI,CAAC,WAAW,CAAC,SAAS,EAAE,WAAW,CAAC,CAAA;IACjD,CAAC;IAED,KAAK,CAAC,uBAAuB,CAAC,KAAuC;QACnE,OAAO,IAAI,CAAC,WAAW,CAAC,uBAAuB,EAAE,KAAK,CAAC,CAAA;IACzD,CAAC;CACF","sourcesContent":["import {CreateAppQuery, CreateAppQuerySchema} from '../../api/graphql/create_app.js'\nimport {\n  AllDevStoresByOrganizationQuery,\n  AllDevStoresByOrganizationSchema,\n} from '../../api/graphql/all_dev_stores_by_org.js'\nimport {DeveloperPlatformClient, Paginateable} from '../developer-platform-client.js'\nimport {fetchPartnersSession, PartnersSession} from '../../../cli/services/context/partner-account-info.js'\nimport {\n  fetchAppDetailsFromApiKey,\n  fetchOrganizations,\n  fetchOrgAndApps,\n  fetchOrgFromId,\n  filterDisabledBetas,\n} from '../../../cli/services/dev/fetch.js'\nimport {MinimalOrganizationApp, Organization, OrganizationApp, OrganizationStore} from '../../models/organization.js'\nimport {selectOrganizationPrompt} from '../../prompts/dev.js'\nimport {ExtensionSpecification} from '../../models/extensions/specification.js'\nimport {fetchSpecifications} from '../../services/generate/fetch-extension-specifications.js'\nimport {\n  AllAppExtensionRegistrationsQuery,\n  AllAppExtensionRegistrationsQuerySchema,\n} from '../../api/graphql/all_app_extension_registrations.js'\nimport {ActiveAppVersionQuery, ActiveAppVersionQuerySchema} from '../../api/graphql/app_active_version.js'\nimport {\n  ExtensionUpdateDraftInput,\n  ExtensionUpdateDraftMutation,\n  ExtensionUpdateSchema,\n} from '../../api/graphql/update_draft.js'\nimport {AppDeploy, AppDeploySchema, AppDeployVariables} from '../../api/graphql/app_deploy.js'\nimport {\n  GenerateSignedUploadUrl,\n  GenerateSignedUploadUrlSchema,\n  GenerateSignedUploadUrlVariables,\n} from '../../api/graphql/generate_signed_upload_url.js'\nimport {isUnitTest} from '@shopify/cli-kit/node/context/local'\nimport {AbortError} from '@shopify/cli-kit/node/error'\nimport {\n  FunctionUploadUrlGenerateMutation,\n  FunctionUploadUrlGenerateResponse,\n  partnersRequest,\n} from '@shopify/cli-kit/node/api/partners'\nimport {GraphQLVariables} from '@shopify/cli-kit/node/api/graphql'\nimport {ensureAuthenticatedPartners} from '@shopify/cli-kit/node/session'\n\n// this is a temporary solution for editions to support https://vault.shopify.io/gsd/projects/31406\n// read more here: https://vault.shopify.io/gsd/projects/31406\nconst MAGIC_URL = 'https://shopify.dev/apps/default-app-home'\nconst MAGIC_REDIRECT_URL = 'https://shopify.dev/apps/default-app-home/api/auth'\n\ninterface AppVars {\n  org: number\n  title: string\n  appUrl: string\n  redir: string[]\n  requestedAccessScopes: string[]\n  type: string\n}\n\nfunction getAppVars(org: Organization, name: string, isLaunchable = true, scopesArray?: string[]): AppVars {\n  if (isLaunchable) {\n    return {\n      org: parseInt(org.id, 10),\n      title: `${name}`,\n      appUrl: 'https://example.com',\n      redir: ['https://example.com/api/auth'],\n      requestedAccessScopes: scopesArray ?? [],\n      type: 'undecided',\n    }\n  } else {\n    return {\n      org: parseInt(org.id, 10),\n      title: `${name}`,\n      appUrl: MAGIC_URL,\n      redir: [MAGIC_REDIRECT_URL],\n      requestedAccessScopes: [],\n      type: 'undecided',\n    }\n  }\n}\n\nexport class PartnersClient implements DeveloperPlatformClient {\n  private _session: PartnersSession | undefined\n\n  constructor(session?: PartnersSession) {\n    this._session = session\n  }\n\n  async session(): Promise<PartnersSession> {\n    if (!this._session) {\n      if (isUnitTest()) {\n        throw new Error('PartnersClient.session() should not be invoked dynamically in a unit test')\n      }\n      this._session = await fetchPartnersSession()\n    }\n    return this._session\n  }\n\n  async makeRequest<T>(query: string, variables: GraphQLVariables | undefined = undefined): Promise<T> {\n    return partnersRequest(query, await this.token(), variables)\n  }\n\n  async token(): Promise<string> {\n    return (await this.session()).token\n  }\n\n  async refreshToken(): Promise<string> {\n    const newToken = await ensureAuthenticatedPartners([], process.env, {noPrompt: true})\n    const session = await this.session()\n    if (newToken) {\n      session.token = newToken\n    }\n    return session.token\n  }\n\n  async accountInfo(): Promise<PartnersSession['accountInfo']> {\n    return (await this.session()).accountInfo\n  }\n\n  async appFromId(appId: string): Promise<OrganizationApp | undefined> {\n    return fetchAppDetailsFromApiKey(appId, await this.token())\n  }\n\n  async organizations(): Promise<Organization[]> {\n    return fetchOrganizations(await this.session())\n  }\n\n  async selectOrg(): Promise<Organization> {\n    const organizations = await this.organizations()\n    return selectOrganizationPrompt(organizations)\n  }\n\n  async orgFromId(orgId: string): Promise<Organization> {\n    return fetchOrgFromId(orgId, await this.session())\n  }\n\n  async orgAndApps(orgId: string): Promise<Paginateable<{organization: Organization; apps: MinimalOrganizationApp[]}>> {\n    const result = await fetchOrgAndApps(orgId, await this.session())\n    return {\n      organization: result.organization,\n      apps: result.apps.nodes,\n      hasMorePages: result.apps.pageInfo.hasNextPage,\n    }\n  }\n\n  async appsForOrg(organizationId: string, term?: string): Promise<Paginateable<{apps: MinimalOrganizationApp[]}>> {\n    const result = await fetchOrgAndApps(organizationId, await this.session(), term)\n    return {\n      apps: result.apps.nodes,\n      hasMorePages: result.apps.pageInfo.hasNextPage,\n    }\n  }\n\n  async specifications(appId: string): Promise<ExtensionSpecification[]> {\n    return fetchSpecifications({token: await this.token(), apiKey: appId})\n  }\n\n  async createApp(\n    org: Organization,\n    name: string,\n    options?: {\n      isLaunchable?: boolean\n      scopesArray?: string[]\n      directory?: string\n    },\n  ): Promise<OrganizationApp> {\n    const variables = getAppVars(org, name, options?.isLaunchable, options?.scopesArray)\n    const result: CreateAppQuerySchema = await this.makeRequest(CreateAppQuery, variables)\n    if (result.appCreate.userErrors.length > 0) {\n      const errors = result.appCreate.userErrors.map((error) => error.message).join(', ')\n      throw new AbortError(errors)\n    }\n\n    const betas = filterDisabledBetas(result.appCreate.app.disabledBetas)\n    return {...result.appCreate.app, organizationId: org.id, newApp: true, betas}\n  }\n\n  async devStoresForOrg(orgId: string): Promise<OrganizationStore[]> {\n    const result: AllDevStoresByOrganizationSchema = await this.makeRequest(AllDevStoresByOrganizationQuery, {\n      id: orgId,\n    })\n    return result.organizations.nodes[0]!.stores.nodes\n  }\n\n  async appExtensionRegistrations(appId: string): Promise<AllAppExtensionRegistrationsQuerySchema> {\n    return this.makeRequest(AllAppExtensionRegistrationsQuery, {apiKey: appId})\n  }\n\n  async activeAppVersion(appId: string): Promise<ActiveAppVersionQuerySchema> {\n    return this.makeRequest(ActiveAppVersionQuery, {apiKey: appId})\n  }\n\n  async functionUploadUrl(): Promise<FunctionUploadUrlGenerateResponse> {\n    return this.makeRequest(FunctionUploadUrlGenerateMutation)\n  }\n\n  async updateExtension(extensionInput: ExtensionUpdateDraftInput): Promise<ExtensionUpdateSchema> {\n    return this.makeRequest(ExtensionUpdateDraftMutation, extensionInput)\n  }\n\n  async deploy(deployInput: AppDeployVariables): Promise<AppDeploySchema> {\n    return this.makeRequest(AppDeploy, deployInput)\n  }\n\n  async generateSignedUploadUrl(input: GenerateSignedUploadUrlVariables): Promise<GenerateSignedUploadUrlSchema> {\n    return this.makeRequest(GenerateSignedUploadUrl, input)\n  }\n}\n"]}